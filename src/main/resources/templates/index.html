<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Перевозки грузов</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" th:href="@{/css/index3.css}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="/">Главная</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li  class="nav-item">
        <a  sec:authorize="hasRole('ROLE_ADMIN')" class="nav-link" id="roleAdmin">Администратор</a>
      </li>
      <li>
        <a sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_USER')" th:text="${#authentication.name}" class="nav-link"></a>
      </li>
<!--      <li class="nav-item">-->
<!--        <a  sec:authorize="hasRole('ROLE_USER')" class="nav-link" id="roleUser">Пользователь</a>-->
<!--      </li>-->
<!--      <li class="nav-item active">-->
<!--        <a sec:authorize="hasRole('ROLE_ADMIN')" class="nav-link" href="/admin_panel">Панель администратора</a>-->
<!--      </li>-->
      <li class="nav-item">
        <a sec:authorize="hasRole('ROLE_ADMIN')" class="nav-link" href="/admin/users">Управление пользователями</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="/auto-blog">Блог</a>
      </li>
      <li class="nav-item active">
        <a sec:authorize="not hasAnyRole('ROLE_ADMIN','ROLE_USER')" class="nav-link" href="/registration">Регистрация</a>
      </li>
      <li class="nav-item active">
        <a sec:authorize="not hasAnyRole('ROLE_ADMIN','ROLE_USER')" class="nav-link" href="/login">Войти</a>
      </li>
      <li class="nav-item active">
        <a sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_USER')" class="nav-link" href="/logout">Выйти</a>
      </li>
    </ul>
  </div>
</nav>
<section>
<div>
    <blockquote class="blockquote text-center text-white"><h1>Перевозки грузов</h1></blockquote>

    <div class="row">
      <blockquote class="blockquote text-center text-white">
        <h5>Поиск по любому критерию:</h5>
        <form th:action="@{/}">
          <input type="text" name="keyword" id="keyword" size="70" th:value="${keyword}" required/>
          <input type="submit" class="btn btn-success btn-sm" value="Поиск"/>
          <input type="button" class="btn btn-danger btn-sm" value="Очистить" id="btnClear"
                 onclick="addParam([], [], ['keyword'])"/>
        </form>
      </blockquote>
    </div>

    <div class="row">
      <blockquote class="blockquote text-center">
        <a  sec:authorize="hasAuthority('ROLE_ADMIN')" href="/new" class="btn btn-success">Добавить запись</a>
        <a sec:authorize="hasAuthority('ROLE_ADMIN')" href="/fill" class="btn btn-success">Заполнить бд</a>
        <a sec:authorize="hasAuthority('ROLE_ADMIN')" href="/truncate" class="btn btn-danger">Очистить бд</a>
      </blockquote>
    </div>

    <p class="text-white fw-bold row-count"></p>

  <div class="data">
    <table id="1" class="table table-hover table-sm text-white">
      <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Название груза</th>
        <th scope="col">Содержимое груза</th>
        <th scope="col">Город отправки</th>
        <th scope="col">Дата отправки</th>
        <th scope="col">Город прибытия</th>
        <th scope="col">Дата прибытия</th>
        <td></td>
      </tr>

      <tr>
        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['id'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['id', '1'])"/>
        </th>

        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['name'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['name', '1'])"/>
        </th>

        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['content'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['content', '1'])"/>
        </th>

        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['citySend'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['citySend', '1'])"/>
        </th>

        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['dateSend'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['dateSend', '1'])"/>
        </th>

        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['cityArrive'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['cityArrive', '1'])"/>
        </th>
        <th scope="col">
          <input type="button" class="btn btn-primary btn-sm" value="ASC"
                 onclick="addParam(['sort_by'], ['dateArrive'], ['reverse'])"/>
          <input type="button" class="btn btn-secondary btn-sm" value="DESC"
                 onclick="addParam(['sort_by', 'reverse'], ['dateArrive', '1'])"/>
        </th>
        <td>
          <input type="button" class="btn btn-warning btn-sm" value="Сбросить сортировку"
                 onclick="addParam([], [], ['sort_by', 'reverse'])"/>
        </td>
      </tr>
      </thead>

      <tbody>
      <tr class="table-tr" th:each="obj: ${List}">
        <th scope="row" class="table-th text-white" th:text="${obj.id}">отстутсвует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.name}">отсутствует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.content}">отсутствует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.citySend}">отсутствует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.dateSend}">отсутствует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.cityArrive}">отсутствует</th>
        <th scope="row" class="table-th text-white" th:text="${obj.dateArrive}">отсутствует</th>
        <td>
          <a sec:authorize="hasAuthority('ROLE_ADMIN')" th:href="@{'/edit/'+${obj.id}}">
            <button type="button" class="btn btn-info">Редактировать</button>
          </a>

          <a sec:authorize="hasAuthority('ROLE_ADMIN')" th:href="@{'/delete/'+${obj.id}}">
            <button type="button" class="btn btn-danger">Удалить</button>
          </a>
        </td>
      </tr>
      </tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <div class="container">
      <canvas sec:authorize="hasAuthority('ROLE_ADMIN')" id="hist" width="600" height="400"></canvas>
    </div>
  </div>
</div>
</section>
<script type="text/javascript">
  function addParam(keys, values, remove) {
    if (remove === undefined) remove = [];

    let url = window.location.href;
    let params = (url.split('?')[1] ? url.slice(url.indexOf('?') + 1).split('&') : '');
    let result = '?';

    for (let i = 0; i < params.length; i++) {
      let temp = params[i].split('=')[0];
      if (!keys.includes(temp) && !remove.includes(temp))
        result += params[i] + '&';
    }

    for (let i = 0; i < keys.length; i++) {
      result += keys[i] + '=' + values[i];

      if (i != keys.length - 1)
        result += '&';
    }

    window.location.search = result;
  }
</script>


<script type="text/javascript">
  let table = document.getElementById('1')
  let tBody = table.querySelector('tbody')
  const count = tBody.querySelectorAll('tr').length;
  document.querySelector('.row-count').innerHTML = 'Количество записей в таблице: ' + count;
</script>

<script th:inline="javascript">
  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
  }

  labels = []
  data = []
  let tr = document.getElementsByClassName('table-tr');
  for (let i = 0; i < tr.length; i++) {
    let t = tr[i].getElementsByClassName('table-th')[3].textContent.split(' ')[0];

    if (!labels.includes(t)) {
      let ind = Math.max(labels.length, 0);
      labels[ind] = t;
      data[ind] = 1;
    } else {
      let ind = labels.indexOf(t);
      data[ind] += 1;
    }
  }

  let colors = [];
  for (let i = 0; i < labels.length; i++) {
    let temp = 'rgb(' + getRandomInt(0, 256) + ', ' + getRandomInt(0, 256) + ', ' + getRandomInt(0, 256) + ')';
    while (colors.includes(temp)) {
      temp = 'rgb(' + getRandomInt(0, 256) + ', ' + getRandomInt(0, 256) + ', ' + getRandomInt(0, 256) + ')';
    }

    colors[i] = temp;
  }

  let dataset = {
    label: 'Количество сеансов',
    data: data,
    backgroundColor: colors,
    borderWidth: 1,
  }

  Chart.defaults.global.defaultFontColor = 'white';

  let ctx = document.getElementById('hist').getContext('2d');
  let myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [dataset],
    },
    options: {
      legend: {
        display: false,
      },
      title: {
        display: true,
        text: 'Количество сеансов по дате',
        position: 'top',
        fontSize: 24,
        padding: 20,
      },
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true,
            stepSize: 1,
          },
          scaleLabel: {
            display: true,
            labelString: 'Количество сеансов',
            fontSize: 18,
          },
        }],
        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'Дата',
            fontSize: 18,
          },
        }],
      },
    },
  });
</script>
</body>
</html>